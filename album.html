<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
        
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Xphone">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <title>公共相册</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="sharedStyles.css">
    <script type="module" src="applyGlobalStyles.js" defer></script> 
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script type="module" src="./spotifyManager.js" defer></script>
   
</head>
<body class="bg-gray-100">
    <input type="file" id="local-image-input" class="hidden" accept="image/*">

    <div class="w-full h-full mx-auto flex flex-col">
        <header class="app-header">
            <div class="flex items-center justify-between relative">
                <a href="index.html" class="header-btn p-1.5 -ml-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                </a>
                <h1 class="text-base font-semibold text-gray-800">公共相册</h1>
                <button id="add-photo-btn" class="header-btn p-1.5 -mr-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                </button>
            </div>
        </header>

        <main id="photo-grid" class="flex-grow main-content px-4 pb-4 overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2"></main>
    </div>

    <script type="module">
        import { db, uploadImage } from './db.js';
        import { showUploadChoiceModal, promptForInput } from './ui-helpers.js';

        // --- DOM Elements ---
        const gridEl = document.getElementById('photo-grid');
        const fileInput = document.getElementById('local-image-input');
        
        async function renderAlbum() {
            gridEl.innerHTML = '';
            const photos = await db.globalAlbum.toArray();
            if (photos.length === 0) {
                gridEl.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">相册是空的，点击右上角添加第一张照片吧。</p>';
                return;
            }

            photos.forEach(photo => {
                const photoContainer = document.createElement('div');
                photoContainer.className = 'relative aspect-square group';
                photoContainer.innerHTML = `
                    <img src="${photo.url}" title="${photo.description}" class="w-full h-full object-cover rounded-lg">
                    <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button data-id="${photo.id}" class="delete-btn text-white bg-red-600 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">×</button>
                    </div>
                `;
                gridEl.appendChild(photoContainer);
            });
        }

        // --- New Unified Upload Flow ---
        async function handleAddPhoto() {
            const choice = await showUploadChoiceModal(fileInput);
            if (!choice) return; // 用户取消或流程已转交

            let imageUrl = null;

            if (choice.type === 'local') {
                try {
                    imageUrl = await uploadImage(choice.value); // choice.value 现在是 File 对象
                } catch (error) {
                    console.error("上传或保存照片失败:", error);
                    return; // 上传失败则中止
                }
            } else if (choice.type === 'url') {
                imageUrl = choice.value;
            }

            if (imageUrl) {
                await processAndSavePhoto(imageUrl);
            }
        }

        
        
        async function processAndSavePhoto(url) {
            // 第四个参数 true 表示这个输入是可选的
            const description = await promptForInput('图片描述 (可选)', '给图片起个名字或描述，留空则AI无法使用', true, true);
            if (description === null) return;

            await db.globalAlbum.add({ url: url.trim(), description: description.trim() });
            await renderAlbum();
        }

        async function deletePhoto(photoId) {
            if (confirm("确定要从公共相册中删除这张照片吗？")) {
                await db.globalAlbum.delete(photoId);
                await renderAlbum();
            }
        }
        
        // --- Event Listeners Setup ---
        document.getElementById('add-photo-btn').addEventListener('click', handleAddPhoto);

        gridEl.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                deletePhoto(id);
            }
        });

        // --- Initial render ---
        renderAlbum();
    </script>
</body>
</html>